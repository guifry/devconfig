#!/usr/bin/env bash
set -euo pipefail

PROFILES_DIR="$HOME/.playwright-profiles"
mkdir -p "$PROFILES_DIR"

python3 -c "import playwright" 2>/dev/null || {
  echo "Error: playwright not installed." >&2
  echo "Run: pip install playwright && playwright install chromium" >&2
  exit 1
}

bytes_to_human() {
  local bytes=$1
  if (( bytes >= 1073741824 )); then
    echo "$(echo "scale=2; $bytes / 1073741824" | bc)GB"
  elif (( bytes >= 1048576 )); then
    echo "$(echo "scale=2; $bytes / 1048576" | bc)MB"
  elif (( bytes >= 1024 )); then
    echo "$(echo "scale=2; $bytes / 1024" | bc)KB"
  else
    echo "${bytes}B"
  fi
}

cmd_list() {
  local json_flag="${1:-}"

  if [[ "$json_flag" == "--json" ]]; then
    python3 - "$PROFILES_DIR" << 'PYTHON'
import json
import os
import sys

profiles_dir = sys.argv[1]
profiles = []

if os.path.isdir(profiles_dir):
    for name in sorted(os.listdir(profiles_dir)):
        profile_path = os.path.join(profiles_dir, name)
        if os.path.isdir(profile_path):
            size = sum(
                os.path.getsize(os.path.join(dirpath, filename))
                for dirpath, _, filenames in os.walk(profile_path)
                for filename in filenames
            )
            profiles.append({"name": name, "path": profile_path, "size_bytes": size})

print(json.dumps({"profiles": profiles}, indent=2))
PYTHON
    return
  fi

  echo "Playwright profiles (~/.playwright-profiles/):"
  echo "-----------------------------------------------"

  local found=false
  for dir in "$PROFILES_DIR"/*/; do
    [[ -d "$dir" ]] || continue
    found=true
    local name
    name=$(basename "$dir")
    local size
    size=$(du -sk "$dir" 2>/dev/null | awk '{print $1 * 1024}')
    printf "  %-20s %s\n" "$name" "$(bytes_to_human ${size:-0})"
  done

  if [[ "$found" == "false" ]]; then
    echo "  (none)"
    echo ""
    echo "Create one with: playwright-auth create <name>"
  fi
}

cmd_create() {
  local name="${1:-}"

  if [[ -z "$name" ]]; then
    echo "Usage: playwright-auth create <name>" >&2
    exit 1
  fi

  local profile_path="$PROFILES_DIR/$name"

  if [[ -d "$profile_path" ]]; then
    echo "Profile already exists: $name" >&2
    echo "Use 'playwright-auth open $name' to open it." >&2
    exit 1
  fi

  mkdir -p "$profile_path"
  echo "Created profile: $name"
  echo "Launching browser for initial login..."
  echo ""
  echo "Log into the services you need, then close the browser."
  echo ""

  python3 - "$profile_path" << 'PYTHON'
import sys
import asyncio
from playwright.async_api import async_playwright

async def main(profile_path):
    async with async_playwright() as p:
        context = await p.chromium.launch_persistent_context(
            user_data_dir=profile_path,
            headless=False,
            args=['--disable-blink-features=AutomationControlled']
        )
        page = context.pages[0] if context.pages else await context.new_page()
        await page.goto('about:blank')
        print("Browser ready. Log in to your services, then close the browser.")
        try:
            while True:
                await asyncio.sleep(1)
                if len(context.pages) == 0:
                    break
        except:
            pass
        await context.close()

asyncio.run(main(sys.argv[1]))
PYTHON

  echo ""
  echo "Profile saved: $name"
}

cmd_open() {
  local name="${1:-}"
  local url="${2:-about:blank}"

  if [[ -z "$name" ]]; then
    echo "Usage: playwright-auth open <name> [url]" >&2
    exit 1
  fi

  local profile_path="$PROFILES_DIR/$name"

  if [[ ! -d "$profile_path" ]]; then
    echo "Profile not found: $name" >&2
    echo "Create it with: playwright-auth create $name" >&2
    exit 1
  fi

  echo "Opening $name..."

  python3 - "$profile_path" "$url" << 'PYTHON'
import sys
import asyncio
from playwright.async_api import async_playwright

async def main(profile_path, url):
    async with async_playwright() as p:
        context = await p.chromium.launch_persistent_context(
            user_data_dir=profile_path,
            headless=False,
            args=['--disable-blink-features=AutomationControlled']
        )
        page = context.pages[0] if context.pages else await context.new_page()
        await page.goto(url)
        print(f"Opened: {url}")
        print("Close the browser when done.")
        try:
            while True:
                await asyncio.sleep(1)
                if len(context.pages) == 0:
                    break
        except:
            pass
        await context.close()

asyncio.run(main(sys.argv[1], sys.argv[2]))
PYTHON

  echo "Session saved."
}

cmd_delete() {
  local name="${1:-}"
  local yes_flag="${2:-}"

  if [[ -z "$name" ]]; then
    echo "Usage: playwright-auth delete <name> [--yes]" >&2
    exit 1
  fi

  local profile_path="$PROFILES_DIR/$name"

  if [[ ! -d "$profile_path" ]]; then
    echo "Profile not found: $name" >&2
    exit 1
  fi

  if [[ "$yes_flag" != "--yes" ]]; then
    read -rp "Delete profile '$name'? [y/N] " confirm
    [[ "$confirm" =~ ^[Yy]$ ]] || exit 0
  fi

  rm -rf "$profile_path"
  echo "Deleted: $name"
}

cmd_help() {
  cat << 'EOF'
playwright-auth - Manage Playwright browser profiles

USAGE
  playwright-auth <command> [args]

COMMANDS
  list [--json]           List all profiles
  create <name>           Create profile and launch browser for login
  open <name> [url]       Open browser with profile
  delete <name> [--yes]   Delete a profile
  help                    Show this help

WORKFLOW
  1. Create a profile and log into your services:
     $ playwright-auth create work
     (Browser opens - log into services - close browser)

  2. Use in Playwright scripts:
     context = await p.chromium.launch_persistent_context(
         user_data_dir=os.path.expanduser('~/.playwright-profiles/work'),
         headless=False
     )

  3. Add more logins or refresh sessions:
     $ playwright-auth open work https://example.com

FILES
  ~/.playwright-profiles/
  ├── work/              # Full browser profile
  ├── personal/          # Another profile
  └── foray/             # Another profile

NOTES
  - Profiles are self-contained Playwright/Chromium profiles
  - Sessions persist across runs (cookies, localStorage, IndexedDB)
  - No Chrome dependency - runs independently
  - Can run while Chrome is open (separate browser)

EXAMPLES
  playwright-auth list
  playwright-auth list --json
  playwright-auth create foray
  playwright-auth open foray https://freeagent.com
  playwright-auth delete old-profile --yes
EOF
}

case "${1:-help}" in
  list) cmd_list "${2:-}" ;;
  create) cmd_create "${2:-}" ;;
  open) cmd_open "${2:-}" "${3:-}" ;;
  delete) cmd_delete "${2:-}" "${3:-}" ;;
  help|--help|-h) cmd_help ;;
  *)
    echo "Unknown command: $1" >&2
    cmd_help >&2
    exit 1
    ;;
esac
